{
    "table_definition": {
        "$ref": "${table_definition_dir}/jobs/xdw/jobfact_by_day.json#/table_definition"
    },
    "source_query": {
        "query_hint": "SQL_NO_CACHE",
        "records": {
            "${AGGREGATION_UNIT}_id": "${:PERIOD_ID}",
            "year": "${:YEAR_VALUE}",
            "${AGGREGATION_UNIT}": "${:PERIOD_VALUE}",
            "record_resource_id": "raw.resource",
            "task_resource_id": "raw.resource",
            "resource_organization_id": "resource_org.id",
            "resourcetype_id": "-1",
            "systemaccount_id": "sa.id",
            "submission_venue_id": "-1",
            "job_record_type_id": "-1",
            "job_task_type_id": "-1",
            "queue": "q.id",
            "allocation_id": "-1",
            "account_id": "-1",
            "requesting_person_id": "p.id",
            "person_id": "p.id",
            "person_organization_id": "person_org.id",
            "person_nsfstatuscode_id": "-1",
            "fos_id": "-1",
            "principalinvestigator_person_id": "person_pi.id",
            "piperson_organization_id": "COALESCE(pi_org.id, 0)",
            "job_time_bucket_id": "(SELECT id FROM ${UTILITY_SCHEMA}.job_times jt WHERE raw.wallduration >= jt.min_duration AND raw.wallduration <= jt.max_duration)",
            "job_wait_time_bucket_id": "(SELECT id FROM ${UTILITY_SCHEMA}.job_wait_times jt WHERE raw.waitduration >= jt.min_duration AND raw.waitduration <= jt.max_duration)",
            "node_count": "0",
            "processor_count": "raw.processor_count",
            "processorbucket_id": "(SELECT id FROM ${UTILITY_SCHEMA}.processor_buckets pb WHERE raw.processor_count BETWEEN pb.min_processors AND pb.max_processors)",
            "gpu_count": "raw.gpu_count",
            "gpubucket_id": "(SELECT id FROM ${UTILITY_SCHEMA}.gpu_buckets gb WHERE raw.gpu_count BETWEEN gb.min_gpus AND gb.max_gpus)",
            "qos_id": "-1",
            "submitted_job_count": "raw.submitted_job_count",
            "ended_job_count": "raw.ended_job_count",
            "started_job_count": "raw.started_job_count",
            "running_job_count": "raw.running_job_count",
            "wallduration": "raw.wallduration",
            "sum_wallduration_squared": "COALESCE(CAST(POW(raw.wallduration, 2) AS DECIMAL(36,4)), 0)",
            "waitduration": "raw.waitduration",
            "sum_waitduration_squared": "COALESCE(CAST(POW(raw.waitduration, 2) AS DECIMAL(36,4)), 0)",
            "local_charge_xdsu": "0",
            "sum_local_charge_xdsu_squared": "0",
            "cpu_time": "COALESCE(raw.processor_count * raw.wallduration, 0)",
            "sum_cpu_time_squared": "COALESCE(CAST(POW(raw.processor_count * raw.wallduration, 2) AS DECIMAL(36,4)), 0)",
            "gpu_time": "COALESCE(raw.gpu_count * raw.wallduration, 0)",
            "sum_gpu_time_squared": "COALESCE(CAST(POW(raw.gpu_count * raw.wallduration, 2) AS DECIMAL(36,4)), 0)",
            "node_time": "0",
            "sum_node_time_squared": "0",
            "sum_weighted_expansion_factor": "0",
            "sum_job_weights": "0",
            "job_id_list": "0"
        },
        "joins": [
            {
                "name": "htcss_raw_logs",
                "schema": "${SOURCE_SCHEMA}",
                "alias": "raw"
            },
            {
                "name": "queue",
                "schema": "${UTILITY_SCHEMA}",
                "alias": "q",
                "type": "LEFT",
                "on": "raw.queue = q.id"
            },
            {
                "name": "systemaccount",
                "schema": "${UTILITY_SCHEMA}",
                "alias": "sa",
                "type": "LEFT",
                "on": "raw.system_account = sa.username"
            },
            {
                "name": "organization",
                "schema": "${UTILITY_SCHEMA}",
                "alias": "resource_org",
                "type": "LEFT",
                "on": "raw.resource_institution = resource_org.name"
            },
            {
                "name": "person",
                "schema": "${UTILITY_SCHEMA}",
                "alias": "p",
                "type": "LEFT",
                "on": "raw.person = p.long_name"
            },
            {
                "name": "organization",
                "schema": "${UTILITY_SCHEMA}",
                "alias": "person_org",
                "type": "LEFT",
                "on": "raw.person_institution = person_org.name"
            },
            {
                "name": "person",
                "schema": "${UTILITY_SCHEMA}",
                "alias": "person_pi",
                "type": "LEFT",
                "on": "raw.project_pi = person_pi.long_name"
            },
            {
                "name": "organization",
                "schema": "${UTILITY_SCHEMA}",
                "alias": "pi_org",
                "type": "LEFT",
                "on": "raw.project_pi_institution = pi_org.name"
            }
        ]
    }
}
